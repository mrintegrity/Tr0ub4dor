<?php  session_start();  //TODO: Clean up error handling code. Including better messages if something goes wrong.  require_once("config.php");  require_once("common_func.php");    check_referrer(BASE_DOMAIN);  //------------------------------------------  // BEGIN: Supporting Functions  //------------------------------------------	function change_password($new_crypt_pw, $old_key, $new_key) {    $success = 1;    // Set db object    $db = get_db_conn();    		$list = $db->out_result_object("SELECT * FROM wallet");		while ( $thisline = $list->fetch_object() ) {      $sql__ = "INSERT INTO wallet VALUES('','" .				$db->conn->real_escape_string(en_crypt(de_crypt($thisline->itemname, $old_key), $new_key)) . "','" .				$db->conn->real_escape_string(en_crypt(de_crypt($thisline->host, $old_key), $new_key)) . "','" .				$db->conn->real_escape_string(en_crypt(de_crypt($thisline->login, $old_key), $new_key)) . "','" .				$db->conn->real_escape_string(en_crypt(de_crypt($thisline->pw, $old_key), $new_key)) . "','" .				$db->conn->real_escape_string(en_crypt(de_crypt($thisline->comment, $old_key), $new_key)) . "')";			      $insert_result = $db->in_sql_no_data($sql__);			$delete_result = $db->in_sql_no_data("DELETE FROM wallet WHERE ID=" . $thisline->ID);		} // while loop		$db->in_sql_no_data("DELETE FROM main");		$result = $db->in_sql_no_data("INSERT INTO main VALUES ('1.40','" . $new_crypt_pw . "')");    		if ($result == 0) {			$success = 0;			// try to delete so that the table remains clean			$db->in_sql_no_data("DELETE FROM main");		}    unset($db);		return $success;	} //change_password()    //------------------------------------------  // END: Supporting Functions  //------------------------------------------    //------------------------------------------  // BEGIN: Main logic block  //------------------------------------------  if ((isset($_SESSION['logged_in'])) && ($_SESSION['logged_in'] == 1)) {  // Session is active    // Require POST    if ($_SERVER['REQUEST_METHOD'] !== 'POST') { go_home(); }        // Any actions to perform?    if (isset($_POST['action'])) {      // Since we have an action to perform, initiate the db object      $db = get_db_conn();            switch (strtolower($_POST['action'])) {        //---------------------------------------        // Save new entry        //---------------------------------------        case "save":          $list = $db->in_sql_no_data("INSERT INTO wallet VALUES('','" .            $db->conn->real_escape_string(en_crypt(htmlentities($_POST['itemname']), $_SESSION['key'])) . "','" .            $db->conn->real_escape_string(en_crypt(htmlentities($_POST['host']), $_SESSION['key'])) . "','" .            $db->conn->real_escape_string(en_crypt(htmlentities($_POST['login']), $_SESSION['key'])) . "','" .            $db->conn->real_escape_string(en_crypt(htmlentities($_POST['password']), $_SESSION['key'])) . "','" .            $db->conn->real_escape_string(en_crypt(htmlentities($_POST['comment']), $_SESSION['key'])) . "');");                    unset($db, $_POST['itemname'], $_POST['host'], $_POST['login'], $_POST['password'], $_POST['comment']);          break; //save                    //---------------------------------------        // Save edited entry        //---------------------------------------        case "editsave":          $list = $db->in_sql_no_data("UPDATE wallet SET itemname='" . $db->conn->real_escape_string(en_crypt(htmlentities($_POST['itemname']), $_SESSION['key'])) .            "', host='" . $db->conn->real_escape_string(en_crypt(htmlentities($_POST['host']), $_SESSION['key'])) .            "', login='" . $db->conn->real_escape_string(en_crypt(htmlentities($_POST['login']), $_SESSION['key'])) .            "', pw='" . $db->conn->real_escape_string(en_crypt(htmlentities($_POST['password']), $_SESSION['key'])) .            "', comment='" . $db->conn->real_escape_string(en_crypt(htmlentities($_POST['comment']), $_SESSION['key'])) .            "' WHERE ID=" . $_POST['ID']);          unset($db, $_POST['itemname'], $_POST['host'], $_POST['login'], $_POST['password'], $_POST['comment']);          break;  //editsave                      //---------------------------------------        // Delete entry        //---------------------------------------        case "reallydelete":          $num_rows = $db->in_sql_no_data("DELETE FROM wallet WHERE ID=".$_POST['ID']);          unset($db);          break;  //delete              //---------------------------------------        // Import uploaded file        //---------------------------------------        case "import":              $row = $_POST['row'];                       // sort header_fields by occurence          asort($row);                    // finally import the data                    $fd = fopen (TMP_PATH."w3pw.csv", "r");          while ($data = fgetcsv ($fd, 4096, ";")) {            if (count($data)>1) {              $mysql_string = "INSERT INTO wallet VALUES(''";              reset($_POST['row']);              while (list ($index, $val) = each ($_POST['row'])) {                $mysql_string.=",'" . $db->conn->real_escape_string(en_crypt($data[$val],$_SESSION['key'])) . "'";              }              $mysql_string.=")";              $db->in_sql_no_data($mysql_string);              unset($mysql_string);            }          }          fclose ($fd);                    unset($row, $data, $db);          break;  //import              //---------------------------------------        // Change Master Password        //---------------------------------------        case "changepw":          // reconfirm existing password          $cleartext_pw = "";          // encrypt the pw given at logon          if (isset($_POST['pw']) && strlen($_POST['pw']) > 0) {            $cleartext_pw = $_POST['pw'];            unset($_POST['pw']);          } else {            $sysmsg__ = '<br /><b>Fill in all fields before continuing</b>....try <a href="../chgpass.php">again</a>';            show_sys_msg($sysmsg__, $SYSMSG_KEY);            exit;          }                    $crypt_pw = sha1($cleartext_pw);          // check pw          $entries = $db->out_row_object("SELECT version, pw FROM main");          $db_pw = $entries->pw;          if ($crypt_pw == $db_pw) {            // password match - proceed            // confirm new passwords match            if ((isset($_POST['newpw']) && isset($_POST['confirm'])) && (strlen($_POST['newpw']) > 0 && strlen($_POST['confirm']) > 0)) {              $newpw = $_POST['newpw'];              $confirm = $_POST['confirm'];                            if ($newpw == $confirm) {                // new passwords match, proceed                $old_key = $_SESSION['key'];                $new_key = md5("%dJ9&".strtolower($newpw)."(/&k.=".strtoupper($newpw)."1x&%");                $new_crypt_pw = sha1($newpw);                                // do the actual change                $res__ = change_password($new_crypt_pw, $old_key, $new_key);                if ($res__ == 0) {                  $sysmsg__ = '<br /><b>Password change FAILED</b>....try <a href="../chgpass.php">again</a>';                } else {                  session_unset();                  session_destroy();                  $sysmsg__ = '<br /><b>Password change SUCCESSFUL</b>....your new password is <span class="sensitive">' . $newpw . '</span>. Please <a href="../index.php">log in</a> with this new password';                }                show_sys_msg($sysmsg__, $SYSMSG_KEY);                exit;                              } else {                //Not all filled out.                $sysmsg__ = '<br /><b>New Password does not match Confirm New Password</b>....try <a href="../chgpass.php">again</a>';                show_sys_msg($sysmsg__, $SYSMSG_KEY);                exit;                              }            } else {              $sysmsg__ = '<br /><b>Fill in all fields before continuing</b>....try <a href="../chgpass.php">again</a>';              show_sys_msg($sysmsg__, $SYSMSG_KEY);              exit;            }                      } else {            $sysmsg__ = '<br /><b>Old Master Password does not match</b>....try <a href="../chgpass.php">again</a>';            show_sys_msg($sysmsg__, $SYSMSG_KEY);            exit;                      } // old pws match          break;  // changepw                } // end switch              // Forward after success      //go_to_url("../main.php&msg=" . $msg__);      go_to_url("../main.php");          } // check $_POST['action']        //------------------------------------------    // END: Main logic block    //------------------------------------------              } //Logged in??>